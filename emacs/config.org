#+TITLE: EMACS
#+AUTHOR: RD
#+STARTUP: showeverything
#+OPTIONS: toc:nil

* PACKAGE MANAGEMENT
#+begin_src emacs-lisp
  ;; straight.el is bootstrapped in init.el (before this file loads)

  ;; Install use-package via straight
  (straight-use-package 'use-package)

  ;; Make straight.el the default package manager for all use-package declarations
  (setq straight-use-package-by-default t)
#+end_src

* TREE-SITTER
#+begin_src emacs-lisp
;; Ensure native architecture compilation (ARM64 on Apple Silicon)
(setq treesit-extra-load-path (list (expand-file-name "tree-sitter" user-emacs-directory)))

;; Register grammar sources
(setq treesit-language-source-alist
      '((python "https://github.com/tree-sitter/tree-sitter-python")
        (c      "https://github.com/tree-sitter/tree-sitter-c")
        (cpp    "https://github.com/tree-sitter/tree-sitter-cpp")
        (cuda   "https://github.com/tree-sitter-grammars/tree-sitter-cuda")))

;; Run: M-x install-treesit-grammars
(defun install-treesit-grammars ()
  "Install all tree-sitter grammars defined in treesit-language-source-alist.
Ensures compilation with native architecture (no Rosetta x86_64)."
  (interactive)
  ;; Set CC to use native clang without Rosetta
  (let ((process-environment (cons "CC=clang" process-environment)))
    (dolist (lang treesit-language-source-alist)
      (let ((lang-name (car lang)))
        (unless (treesit-language-available-p lang-name)
          (message "Installing tree-sitter grammar for %s..." lang-name)
          (treesit-install-language-grammar lang-name))))))

;; Use tree-sitter modes for Python and C++
(add-to-list 'auto-mode-alist '("\\.py\\'" . python-ts-mode))
(add-to-list 'auto-mode-alist '("\\.c\\'" . c-ts-mode))
(add-to-list 'auto-mode-alist '("\\.cpp\\'" . c++-ts-mode))
(add-to-list 'auto-mode-alist '("\\.h\\'" . c-ts-mode))
(add-to-list 'auto-mode-alist '("\\.hpp\\'" . c++-ts-mode))

;; CUDA mode: inherits from c++-ts-mode
(define-derived-mode cuda-ts-mode c++-ts-mode "CUDA"
  "Major mode for CUDA, derived from c++-ts-mode.")

;; Use CUDA mode for .cu and .cuh files
(add-to-list 'auto-mode-alist '("\\.cu\\'" . cuda-ts-mode))
(add-to-list 'auto-mode-alist '("\\.cuh\\'" . cuda-ts-mode))
#+end_src

* COMPLETION SYSTEM
#+begin_src emacs-lisp
;; Vertico + Consult + Marginalia + Embark
;; Vertico: Vertical completion UI
(use-package vertico
  :init
  (vertico-mode))
;; Save minibuffer history across Emacs sessions
(use-package savehist
  :init
  (savehist-mode))
;; Marginalia: Shows file sizes, command descriptions, etc.
(use-package marginalia
  :after vertico
  :init
  (marginalia-mode))
;; Consult: Enhanced search and navigation commands
(use-package consult
  :bind (("C-x b"   . consult-buffer)       ;; Switch buffer (better than default)
         ("M-y"     . consult-yank-pop)     ;; Browse kill ring
         ("C-x C-r" . consult-recent-file)  ;; Open recent file
         ("C-c f"   . consult-find)))       ;; Find files
;; C-s will use default isearch-forward
;; Embark: Context-sensitive actions (right-click menu for minibuffer)
(use-package embark
  :bind (("C-."   . embark-act)         ;; Perform action on thing at point
         ("C-;"   . embark-dwim)        ;; Smart default action
         ("C-h B" . embark-bindings))   ;; Show all keybindings
  :init
  (setq prefix-help-command #'embark-prefix-help-command))
;; Embark + Consult integration
(use-package embark-consult
  :after (embark consult)
  :demand t)
;; Recent files: Access with: C-x C-r (consult-recent-file)
(use-package recentf
  :init
  (recentf-mode 1)
  (setq recentf-max-menu-items 25      ;; Show up to 25 recent files
        recentf-max-saved-items 100))  ;; Remember 100 files across sessions
#+end_src

* DEFAULTS
#+begin_src emacs-lisp

;; When text is selected and you type, replace the selection (like most editors)
(delete-selection-mode 1)
;; Auto-revert buffers when files change on disk (useful for git operations)
(global-auto-revert-mode 1)
;; Automatically close brackets, quotes, and parentheses
(electric-pair-mode 1)
;; Don't create auto-save-list files that track auto-saved files
(setq auto-save-list-file-prefix nil)
;; Enable transient mark mode (highlight the active region)
(setq transient-mark-mode t)
;; Disable mouse highlighting (prevents accidental highlighting with mouse movement)
(setq mouse-highlight nil)
;; Allow evaluation of local variables in files (e.g., -*- mode: python -*-)
(setq enable-local-eval t)
;; Disable backup files (filename~ files)
(setq make-backup-files nil)
;; Disable auto-save files (#filename# files)
(setq auto-save-default nil)
;; Replace "yes or no" prompts with shorter "y or n" prompts
(defalias 'yes-or-no-p 'y-or-n-p)
#+end_src

* APPEARANCE AND THEME
#+begin_src emacs-lisp
;; Load custom theme from themes directory
(add-to-list 'custom-theme-load-path (expand-file-name "themes" user-emacs-directory))
(load-theme 'custom-dark t)

;; Remove GUI clutter for a clean, terminal-like appearance
(menu-bar-mode -1)    ;; Remove the menu bar (File, Edit, Options, etc.)
(tool-bar-mode -1)    ;; Remove the toolbar with icons
(scroll-bar-mode -1)  ;; Remove the scroll bars
;; Font configuration (height 120 = 120% of default size, good for macOS)
(set-face-attribute 'default nil :height 120)
;; Line and column numbers in the margin
(global-display-line-numbers-mode 1)  ;; Show line numbers in all buffers
(setq display-line-numbers-type t)    ;; Use absolute line numbers (not relative)
(column-number-mode 1)                ;; Show column number in the modeline
;; Window transparency (95% opaque, 5% transparent)
;; First number: active window opacity, Second number: inactive window opacity
(set-frame-parameter (selected-frame) 'alpha '(95 . 95))       ;; Current frame
(add-to-list 'default-frame-alist '(alpha . (95 . 95)))        ;; Future frames
#+end_src

* TRAMP (SSH SUPPORT)
#+begin_src emacs-lisp
;; TRAMP: Edit files over SSH transparently
;; Usage: C-x C-f /ssh:user@host:/path/to/file
(setq tramp-default-method "ssh")
(setq tramp-verbose 1)  ;; Lower verbosity (less debug output)
#+end_src

* GIT INTEGRATION
#+begin_src emacs-lisp
;; Magit
(use-package magit
  :bind (("C-x g" . magit-status))  ;; Open git status
  :config
  (setq magit-display-buffer-function
        #'magit-display-buffer-fullframe-status-v1))

;; diff-hl: Show git changes in the left fringe (margin)
(use-package diff-hl
  :hook ((prog-mode  . diff-hl-mode)
         (org-mode   . diff-hl-mode)
         (dired-mode . diff-hl-dired-mode)
         (after-init . global-diff-hl-mode))
  :config
  (diff-hl-flydiff-mode 1)
  (add-hook 'tramp-post-connection-hook #'diff-hl-update))
#+end_src

* PROJECT MANAGEMENT
#+begin_src emacs-lisp
;; Projectile: Project navigation and management
(use-package projectile
  :init
  (projectile-mode +1)
  :custom
  (projectile-completion-system 'vertico)
  :bind-keymap
  ("C-c p" . projectile-command-map)  ;; C-c p prefix for projectile commands
  :config
  (setq projectile-switch-project-action #'projectile-dired))

;; Treemacs: File tree sidebar
(use-package treemacs
  :bind (("C-c t" . treemacs))  ;; Toggle treemacs sidebar
  :config
  ;; Disable icons for minimal aesthetic
  (setq treemacs-no-png-images t)
  ;; Follow current file
  (treemacs-follow-mode t)
  ;; Integration with projectile
  (treemacs-project-follow-mode t))

;; Treemacs + Projectile integration
(use-package treemacs-projectile
  :after (treemacs projectile))

;; Treemacs + Magit integration
(use-package treemacs-magit
  :after (treemacs magit))
#+end_src

* UI ENHANCEMENTS
#+begin_src emacs-lisp
;; which-key: Show available keybindings in popup
(use-package which-key
  :init
  (which-key-mode 1)
  :config
  (setq which-key-idle-delay 0.5))  ;; Show after 0.5 seconds

;; doom-modeline: Better status line at bottom
(use-package doom-modeline
  :init
  (doom-modeline-mode 1)
  :custom
  (doom-modeline-height 15)
  ;; Disable icons for minimal aesthetic
  (doom-modeline-icon nil)
  (doom-modeline-buffer-state-icon nil)
  (doom-modeline-buffer-modification-icon nil)
  ;; Show git info
  (doom-modeline-vcs-max-length 20)
  ;; Show Python venv
  (doom-modeline-python-executable "python")
  (doom-modeline-env-version t)
  (doom-modeline-env-enable-python t))
#+end_src

* ORG MODE
#+begin_src emacs-lisp
;; Basic org-mode settings
(setq org-startup-indented t          ;; Indent content under headings
      org-return-follows-link t       ;; RET follows links
      org-image-actual-width nil)     ;; Don't force image width

;; org-tempo: Quick structure templates (type <s TAB for code block, etc.)
(require 'org-tempo)
;; org-bullets: Pretty bullets instead of asterisks
(use-package org-bullets
  :hook (org-mode . org-bullets-mode))
;; toc-org: Automatically generate/update table of contents
;; Add a :toc at the top to generate.
(use-package toc-org
  :hook (org-mode . toc-org-enable))
;; org-fragtog: Live LaTeX preview in org files
;; Just use something like $e = mc^2$
(use-package org-fragtog
  :hook (org-mode . org-fragtog-mode))
;; LaTeX export settings (for HTML export with math)
(setq org-html-with-latex 'mathjax)
(setq org-html-mathjax-options
      '((path "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js")
        (scale "1")
        (align "center")
        (indent "2em")
        (tags "ams")))
;; org-roam: Zettelkasten note-taking system with backlinks
;; Configured for hierarchical folder organization with transclusion
(use-package org-roam
  :custom
  (org-roam-directory "~/Github/rivendell")
  (org-roam-completion-everywhere t)

  ;; Custom capture templates for folder-based organization
  (org-roam-capture-templates
   '(("d" "default" plain "%?"
      :target (file+head "%<%Y%m%d%H%M%S>-${slug}.org"
                         "#+title: ${title}\n")
      :unnarrowed t)

     ("a" "atomic note" plain
      "* Summary\n\n%?\n\n* Details\n\n* Related\n"
      :target (file+head "${subject}/${topic}/${slug}.org"
                         "#+title: ${title}\n#+filetags: :${subject}:${topic}:\n")
      :unnarrowed t)

     ("l" "long-running note" plain
      "* Overview\n\n%?\n\n* Embedded Topics\n\n"
      :target (file+head "${subject}/${topic}/long-running-${slug}.org"
                         "#+title: ${title}\n#+filetags: :${subject}:${topic}:longrunning:\n")
      :unnarrowed t)))

  :bind (("C-c n f" . org-roam-node-find)          ;; Find or create note
         ("C-c n i" . org-roam-node-insert)        ;; Insert link to note
         ("C-c n l" . org-roam-buffer-toggle)      ;; Toggle backlinks
         ("C-c n d" . org-roam-dailies-goto-today) ;; Today's daily note
         ("C-c n c" . org-roam-capture))           ;; Capture new note
  :config
  ;; Initialize the database on startup
  (org-roam-db-autosync-mode))

;; org-roam-ui: Visual graph interface for org-roam
;; Access with: M-x org-roam-ui-mode
(use-package org-roam-ui
  :after org-roam
  :custom
  (org-roam-ui-sync-theme t)
  (org-roam-ui-follow t)
  (org-roam-ui-update-on-save t))

;; org-transclusion: Embed content from other org files dynamically
;; Use #+transclude: [[file:path.org]] to embed content
;; Enable with: M-x org-transclusion-mode or C-c n t
(use-package org-transclusion
  :after org
  :bind (("C-c n t" . org-transclusion-add)           ;; Add transclusion at point
         ("C-c n T" . org-transclusion-mode)          ;; Toggle transclusion mode
         ("C-c n e" . org-transclusion-make-from-link)) ;; Make transclusion from link
  :custom
  (org-transclusion-exclude-elements nil))
#+end_src

* LATEX
#+begin_src emacs-lisp
;; AUCTeX: Enhanced LaTeX editing
(use-package auctex
  :config
  (setq TeX-auto-save t                    ;; Auto-save style information
        TeX-parse-self t                   ;; Parse documents to provide completion
        TeX-command-default "LatexMk"      ;; Use latexmk by default (handles multiple passes)
        LaTeX-command "latex -shell-escape" ;; Enable shell-escape for minted, etc.
        ;; Disable special fontification of superscripts/subscripts (keeps text uniform)
        font-latex-fontify-script nil))

;; pdf-tools: View PDFs inside Emacs (better than DocView)
(use-package pdf-tools
  :config
  (pdf-tools-install)

  ;; Use pdf-tools for viewing PDFs
  (setq TeX-view-program-selection '((output-pdf "PDF Tools"))
        TeX-source-correlate-start-server t)
  (setq TeX-view-program-list '(("PDF Tools" TeX-pdf-tools-sync-view)))

  ;; Auto-refresh PDF after compilation
  (add-hook 'TeX-after-compilation-finished-functions #'TeX-revert-document-buffer)

  ;; Press RET in TeX buffer to view PDF
  (add-hook 'TeX-mode-hook
            (lambda ()
              (define-key TeX-mode-map (kbd "RET") 'TeX-view)))

  ;; Auto-revert PDF when file changes
  (add-hook 'doc-view-mode-hook 'auto-revert-mode)

  ;; Disable line numbers in PDF view (cleaner)
  (add-hook 'pdf-view-mode-hook
            (lambda ()
              (display-line-numbers-mode -1))))
#+end_src

* DEVELOPMENT TOOLS
#+begin_src emacs-lisp
;; Company: Auto-completion framework
(use-package company
  :hook (prog-mode . company-mode)  ;; Enable in all programming modes
  :custom
  (company-idle-delay 0.1)                 ;; Show completions after 0.1s
  (company-minimum-prefix-length 1)        ;; Show completions after 1 character
  :config
  ;; Enable in tree-sitter modes
  (add-hook 'python-ts-mode-hook #'company-mode)
  (add-hook 'c-ts-mode-hook #'company-mode)
  (add-hook 'c++-ts-mode-hook #'company-mode)
  (add-hook 'cuda-ts-mode-hook #'company-mode))

;; yasnippet: Code snippet system
(use-package yasnippet
  :init
  (yas-global-mode 1)  ;; Enable snippets globally
  :config
  (setq yas-snippet-dirs
        (list (expand-file-name "snippets" user-emacs-directory))))

;; yasnippet-snippets: Collection of pre-made snippets
(use-package yasnippet-snippets
  :after yasnippet)

;; vterm: Full-featured terminal emulator
(use-package vterm
  :commands vterm
  :bind ("C-c v" . vterm)  ;; C-c v to open terminal
  :custom
  (vterm-shell "/bin/bash")        ;; Change to zsh/fish if you prefer
  (vterm-max-scrollback 10000))    ;; Keep 10k lines of scrollback
#+end_src

* PYTHON DEVELOPMENT
#+begin_src emacs-lisp
;; Helper function: only start LSP for local files (not over TRAMP/SSH)
(defun my/lsp-deferred-if-local ()
  "Start LSP only if file is local (not remote via TRAMP)."
  (unless (file-remote-p default-directory)
    (lsp-deferred)))

;; LSP mode
(use-package lsp-mode
  :hook ((python-ts-mode . my/lsp-deferred-if-local)   ;; Enable for local Python files
         (python-mode . my/lsp-deferred-if-local))     ;; Fallback for non-ts mode
  :commands (lsp lsp-deferred)
  :custom
  (lsp-keymap-prefix "C-c l")                          ;; Prefix for LSP commands
  (lsp-enable-symbol-highlighting t)                   ;; Highlight symbol at point
  (lsp-prefer-flymake nil)                            ;; Use flycheck instead
  (lsp-idle-delay 0.5)                                ;; Debounce time
  ;; Pyright specific settings
  (lsp-pyright-auto-import-completions t)             ;; Auto-import suggestions
  (lsp-pyright-use-library-code-for-types t)          ;; Infer types from libraries
  ;; Disable specific diagnostics (adjust as needed)
  ;; (lsp-pyright-diagnostic-mode "openFilesOnly")       ;; Only check open files
  (lsp-pyright-type-checking-mode "standard"))           ;; Less strict type checking

;; lsp-ui: UI improvements for LSP (sideline info, docs, etc.)
(use-package lsp-ui
  :after lsp-mode
  :hook (lsp-mode . lsp-ui-mode)
  :custom
  (lsp-ui-doc-enable t)                    ;; Show docs on hover
  (lsp-ui-doc-show-with-cursor t)          ;; Show docs when cursor is on symbol
  (lsp-ui-sideline-enable t)               ;; Show info in sideline
  (lsp-ui-sideline-show-diagnostics t))    ;; Show errors/warnings in sideline

;; lsp-pyright: Python language server
(use-package lsp-pyright
  :after lsp-mode
  :hook (python-ts-mode . (lambda ()
                            (require 'lsp-pyright)
                            (lsp-deferred))))

;; Python virtual environment management
(use-package pyvenv
  :config
  ;; Auto-activate venv/.venv if present in project
  (defun my/auto-activate-venv ()
    "Auto-activate a Python virtual environment if venv or .venv exists."
    (let* ((root (or (locate-dominating-file default-directory "venv")
                     (locate-dominating-file default-directory ".venv")))
           (venv-path (when root
                        (expand-file-name
                         (if (file-exists-p (expand-file-name "venv" root))
                             "venv"
                           ".venv")
                         root))))
      (when (and venv-path (file-directory-p venv-path))
        (pyvenv-activate venv-path)
        (message "Activated venv: %s" venv-path))))

  (add-hook 'python-ts-mode-hook #'my/auto-activate-venv)
  (add-hook 'python-mode-hook #'my/auto-activate-venv))
#+end_src

* C++/CUDA DEVELOPMENT
#+begin_src emacs-lisp
  (use-package lsp-mode
    :hook ((c-ts-mode . my/lsp-deferred-if-local)
           (c++-ts-mode . my/lsp-deferred-if-local)
           (cuda-ts-mode . my/lsp-deferred-if-local))
    :custom
    (lsp-clients-clangd-executable "clangd")
    :config
    ;; Configure CUDA mode to use clangd as C++
    (add-to-list 'lsp-language-id-configuration '(cuda-ts-mode . "cpp"))

    (with-eval-after-load 'lsp-mode
      (lsp-register-client
       (make-lsp-client
        :new-connection (lsp-stdio-connection "clangd")
        :activation-fn (lsp-activate-on "cpp")
        :major-modes '(cuda-ts-mode)
        :server-id 'clangd-cuda))))

  ;; clang-format: Code formatting
  (use-package clang-format
    :bind (("C-c C-f" . clang-format-buffer)      ;; Format whole buffer
           ("C-c C-r" . clang-format-region)))    ;; Format region
  ;; Note: NOT auto-formatting on save to avoid indentation issues
  ;; Use C-c C-f to manually format when needed

  ;; CUDA keyword highlighting
  (with-eval-after-load 'cuda-ts-mode
    (font-lock-add-keywords 'cuda-ts-mode
      '(("__global__"   . font-lock-keyword-face)
        ("__device__"   . font-lock-keyword-face)
        ("__host__"     . font-lock-keyword-face)
        ("__shared__"   . font-lock-keyword-face)
        ("__constant__" . font-lock-keyword-face)
        ("__syncthreads" . font-lock-builtin-face)
        ("blockIdx" . font-lock-builtin-face)
        ("threadIdx" . font-lock-builtin-face)
        ("blockDim" . font-lock-builtin-face)
        ("gridDim" . font-lock-builtin-face))))

  ;; CUDA setup hook
  (defun my/cuda-setup ()
    "Setup function for CUDA mode."
    (setq-local indent-tabs-mode nil)
    ;; Disable some LSP features that can be noisy in CUDA
    (setq-local lsp-completion-enable-additional-text-edit nil
                lsp-eldoc-enable-hover t
                lsp-signature-auto-activate t))

  (add-hook 'cuda-ts-mode-hook #'my/cuda-setup)
#+end_src

* KEYBINDINGS
#+begin_src emacs-lisp
;; Reload config
(global-set-key (kbd "C-c r") (lambda () (interactive) (load-file user-init-file)))
;; Better buffer list
(global-set-key (kbd "C-x C-b") 'ibuffer)
;; Zoom in/out
(global-set-key (kbd "C-=") 'text-scale-increase)
(global-set-key (kbd "C--") 'text-scale-decrease)
#+end_src
